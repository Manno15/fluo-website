<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/fluo.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Montserrat:700,400">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" >
    <link rel="canonical" href="https://fluo.apache.org//tour/exercise-1/">
    <link rel="icon" type="image/png" href="/resources/favicon.png">
    <title>Word count Exercise | Apache Fluo</title>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div id="fluo-nav" class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <div class="navbar-toggle-wrapper visible-xs">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".js-navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <a href="/" class="navbar-brand"><img src="/resources/fluo-logo.png" alt="Apache Fluo"></a>
        </div>
        <div class="collapse navbar-collapse js-navbar-collapse" style="margin-top: 20px">
          <ul class="navbar-nav nav">
            <li><a href="/release/">Releases</a></li>
            <li><a href="/tour/">Tour</a></li>
            <li><a href="/docs/">Docs</a></li>
            <li><a href="/apidocs/">API</a></li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Community<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/getinvolved/">Get Involved</a></li>
                <li><a href="/news/">News Archive</a></li>
                <li><a href="/people/">People</a></li>
                <li><a href="/related-projects/">Related Projects</a></li>
                <li><a href="/poweredby/">Powered By</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Contributing<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="/how-to-contribute/">How To Contribute</a></li>
                <li><a href="/release-process/">Release Process</a></li>
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav nav navbar-right">
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">Apache Software Foundation<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="https://www.apache.org">Apache Homepage</a></li>
                <li><a href="https://www.apache.org/licenses/LICENSE-2.0">License</a></li>
                <li><a href="https://www.apache.org/foundation/sponsorship">Sponsorship</i></a></li>
                <li><a href="https://www.apache.org/security">Security</a></li>
                <li><a href="https://www.apache.org/foundation/thanks">Thanks</a></li>
                <li><a href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
          <div class="col-sm-12">
              


<div id="tour-header">
  <h2><a href="/tour/">Fluo Tour</a>: Word count Exercise</h2>
  <p class="text-muted">Tour page 19 of 26</p>
</div>
<div id="tour-content">
  <p>This excercise gives you an opportunity to use everything you have learned so
far to attempt writing a simple Fluo application.  A bare minimum of code,
along with a conceptual sketch of a solution, is provided to get you started.</p>

<p>The application should compute word counts for unique documents. This
application should do the following.</p>

<ul>
  <li>Deduplicate content based on hash</li>
  <li>Count how many URIs reference content</li>
  <li>For the unique words in content, update global word counts.</li>
  <li>When new content is added increment the global counts.</li>
  <li>When content is no longer referenced by any URIs, decrement the global word counts and delete
that content.</li>
  <li>Partition different types of data using row prefixes.  Use <em>u:</em> for URIs, use <em>d:</em> for document
content, and use <em>w:</em> for word counts.</li>
</ul>

<h2 id="part-1--loading-data">Part 1 : Loading data.</h2>

<p>The class below is a simple POJO for documents.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">ft</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.hash.Hashing</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Document</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">uri</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">Document</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">hash</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//use short prefix of hash for example</span>
    <span class="k">return</span> <span class="n">Hashing</span><span class="o">.</span><span class="na">sha1</span><span class="o">().</span><span class="na">hashString</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">7</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The following code loads documents into Fluo.  It should do the following :</p>

<ul>
  <li>Keep track of the current hash associated with a URI.</li>
  <li>Deduplicate content based on hash</li>
  <li>Reference count how many URIs point to content.  Track this information in a column named
<em>doc:refc</em> with a row based on the hash.</li>
  <li>Track the status of whether content is referenced or unreferenced in a column named <em>doc:refs</em>.
Note <em>refs</em> is short for reference status.   When the reference count for content is 0 this
columns value should be <em>unreferenced</em>.  When the reference count is greater than 0, the
<em>doc:refs</em> columns value should be <em>referenced</em>.  In a later example, an Observer will watch this
column.</li>
  <li>Track the content associated with a hash using the <em>doc:content</em> column.</li>
</ul>

<p>Some of this is implemented below, but not all. The parts that are not done have TODOs.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">ft</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.fluo.api.client.Loader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.client.TransactionBase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.data.Column</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DocLoader</span> <span class="kd">implements</span> <span class="n">Loader</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Document</span> <span class="n">doc</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">HASH_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"uri"</span><span class="o">,</span> <span class="s">"hash"</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">REF_COUNT_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"doc"</span><span class="o">,</span> <span class="s">"refc"</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">REF_STATUS_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"doc"</span><span class="o">,</span> <span class="s">"refs"</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">CONTENT_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"doc"</span><span class="o">,</span> <span class="s">"content"</span><span class="o">);</span>

  <span class="kd">public</span> <span class="nf">DocLoader</span><span class="o">(</span><span class="n">Document</span> <span class="n">doc</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="n">TransactionBase</span> <span class="n">tx</span><span class="o">,</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">newHash</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">hash</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">oldHash</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="na">gets</span><span class="o">(</span><span class="s">"u:"</span> <span class="o">+</span> <span class="n">doc</span><span class="o">.</span><span class="na">uri</span><span class="o">,</span> <span class="n">HASH_COL</span><span class="o">);</span>

    <span class="c1">// TODO check if uri already has the same content hash.  If so, then nothing to do.</span>

    <span class="c1">// TODO set the new hash associated with the URI</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">oldHash</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// TODO decrement the reference count at row "d:"+oldHash</span>
      <span class="c1">// TODO set REF_STATUS_COL to "unreferenced" when the reference count goes from 1 to 0. Do</span>
      <span class="c1">// this for row "d:"+oldHash</span>
    <span class="o">}</span>

    <span class="c1">// TODO increment the reference count for the newHash content.</span>
    <span class="c1">// TODO add the new content when the reference count does not exists</span>
    <span class="c1">// TODO set REF_STATUS_COL to "referenced" when the reference count for the new content goes</span>
    <span class="c1">// from 0 to 1.  Do this for row "d:"+newHash</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Add the following to the ft.Main class.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>  <span class="c1">// some test data</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Document</span><span class="o">[]</span> <span class="n">docs1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">[]</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="s">"http://news.com/a23"</span><span class="o">,</span>
          <span class="s">"Jebediah orbits Mun for 35 days.  No power, forgot solar panels."</span><span class="o">),</span>
      <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="s">"http://news.com/a24"</span><span class="o">,</span>
          <span class="s">"Bill plans to rescue Jebediah after taking tourist to Minimus."</span><span class="o">)};</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Document</span><span class="o">[]</span> <span class="n">docs2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">[]</span> <span class="o">{</span><span class="k">new</span> <span class="n">Document</span><span class="o">(</span><span class="s">"http://oldnews.com/a23"</span><span class="o">,</span>
      <span class="s">"Jebediah orbits Mun for 35 days.  No power, forgot solar panels."</span><span class="o">)};</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Document</span><span class="o">[]</span> <span class="n">docs3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Document</span><span class="o">[]</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="s">"http://news.com/a23"</span><span class="o">,</span>
          <span class="s">"Jebediah orbits Mun for 38 days.  No power, forgot solar panels."</span><span class="o">),</span>
      <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="s">"http://news.com/a24"</span><span class="o">,</span>
          <span class="s">"Crisis at KSC.  Tourist stuck at Minimus.  Bill forgot solar panels."</span><span class="o">)};</span>

  <span class="cm">/**
   * Utility method for loading documents and printing out Fluo table after load completes.
   */</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loadAndPrint</span><span class="o">(</span><span class="n">MiniFluo</span> <span class="n">mini</span><span class="o">,</span> <span class="n">FluoClient</span> <span class="n">client</span><span class="o">,</span> <span class="n">Document</span><span class="o">[]</span> <span class="n">docs</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">try</span> <span class="o">(</span><span class="n">LoaderExecutor</span> <span class="n">loaderExecutor</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">newLoaderExecutor</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Document</span> <span class="n">document</span> <span class="o">:</span> <span class="n">docs</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loaderExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">DocLoader</span><span class="o">(</span><span class="n">document</span><span class="o">));</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="c1">// this will close loaderExecutor and wait for all load transactions to complete</span>

    <span class="c1">//This line is not needed in this step of the excercise.  However the next step will need this</span>
    <span class="c1">//line.</span>
    <span class="n">mini</span><span class="o">.</span><span class="na">waitForObservers</span><span class="o">();</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"**** begin table dump ****"</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">(</span><span class="n">Snapshot</span> <span class="n">snap</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">newSnapshot</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">snap</span><span class="o">.</span><span class="na">scanner</span><span class="o">().</span><span class="na">build</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">rcv</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  "</span> <span class="o">+</span> <span class="n">rcv</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"**** end table dump ****\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">excercise</span><span class="o">(</span><span class="n">MiniFluo</span> <span class="n">mini</span><span class="o">,</span> <span class="n">FluoClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">loadAndPrint</span><span class="o">(</span><span class="n">mini</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">docs1</span><span class="o">);</span>
    <span class="n">loadAndPrint</span><span class="o">(</span><span class="n">mini</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">docs2</span><span class="o">);</span>
    <span class="n">loadAndPrint</span><span class="o">(</span><span class="n">mini</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">docs3</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>Once the TODOs in the DocLoader class are implemented, running Main should print out the following.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**** begin table dump ****
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc refc  1
  d:a6c4d1f doc refs  referenced
  d:cf8ddc0 doc content  Bill plans to rescue Jebediah after taking tourist to Minimus.
  d:cf8ddc0 doc refc  1
  d:cf8ddc0 doc refs  referenced
  u:http://news.com/a23 uri hash  a6c4d1f
  u:http://news.com/a24 uri hash  cf8ddc0
**** end table dump ****

**** begin table dump ****
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc refc  2
  d:a6c4d1f doc refs  referenced
  d:cf8ddc0 doc content  Bill plans to rescue Jebediah after taking tourist to Minimus.
  d:cf8ddc0 doc refc  1
  d:cf8ddc0 doc refs  referenced
  u:http://news.com/a23 uri hash  a6c4d1f
  u:http://news.com/a24 uri hash  cf8ddc0
  u:http://oldnews.com/a23 uri hash  a6c4d1f
**** end table dump ****

**** begin table dump ****
  d:2732ebc doc content  Crisis at KSC.  Tourist stuck at Minimus.  Bill forgot solar panels.
  d:2732ebc doc refc  1
  d:2732ebc doc refs  referenced
  d:6658252 doc content  Jebediah orbits Mun for 38 days.  No power, forgot solar panels.
  d:6658252 doc refc  1
  d:6658252 doc refs  referenced
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc refc  1
  d:a6c4d1f doc refs  referenced
  d:cf8ddc0 doc content  Bill plans to rescue Jebediah after taking tourist to Minimus.
  d:cf8ddc0 doc refc  0
  d:cf8ddc0 doc refs  unreferenced
  u:http://news.com/a23 uri hash  6658252
  u:http://news.com/a24 uri hash  2732ebc
  u:http://oldnews.com/a23 uri hash  a6c4d1f
**** end table dump ****
</code></pre>
</div>

<h2 id="part-2--computing-word-counts">Part 2 : Computing word counts.</h2>

<p>Now that you have data loading, create an observer that watches the reference
status column.  This observer should increment word counts when new content is
referenced and decrement word counts when content is dereferenced.  The
observer should also delete the content when its dereferenced.</p>

<p>Make sure you handle the following scenario correctly.</p>

<ul>
  <li>content A becomes referenced</li>
  <li>content A becomes unreferenced</li>
  <li>an observer runs on content A</li>
</ul>

<p>In this situation, word counts were never incremented for content A so there is no need to decrement
the word counts.  One way to handle this is to have a column that tracks if word counts were
incremented.</p>

<p>Below is a skeleton for an observer to compute word counts.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">ft</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.google.common.collect.ImmutableSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.client.TransactionBase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.data.Bytes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.data.Column</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.data.RowColumn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.fluo.api.observer.AbstractObserver</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContentObserver</span> <span class="kd">extends</span> <span class="n">AbstractObserver</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">PROCESSED_COL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"doc"</span><span class="o">,</span> <span class="s">"processed"</span><span class="o">);</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Column</span> <span class="n">WORD_COUNT</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span><span class="s">"docCount"</span><span class="o">);</span>

  <span class="cm">/**
   * Utility method to tokenize the content of a document into unique words.
   */</span>
  <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">tokenize</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"[ .!,]+"</span><span class="o">)));</span>
  <span class="o">}</span>

  <span class="cm">/**
   *  Adds the passed to delta to the values for each word.
   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">adjustCounts</span><span class="o">(</span><span class="n">TransactionBase</span> <span class="n">tx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">words</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODO make a single call to get all of the current word counts.  Could use</span>
    <span class="c1">//tx.gets(Collection&lt;RowColumn&gt;)</span>

    <span class="c1">// TODO for each word, add delta to the current value and set the new value</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">TransactionBase</span> <span class="n">tx</span><span class="o">,</span> <span class="n">Bytes</span> <span class="n">brow</span><span class="o">,</span> <span class="n">Column</span> <span class="n">col</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

    <span class="n">String</span> <span class="n">row</span> <span class="o">=</span> <span class="n">brow</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">Column</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">colVals</span> <span class="o">=</span>
        <span class="n">tx</span><span class="o">.</span><span class="na">gets</span><span class="o">(</span><span class="n">row</span><span class="o">,</span> <span class="n">DocLoader</span><span class="o">.</span><span class="na">CONTENT_COL</span><span class="o">,</span> <span class="n">DocLoader</span><span class="o">.</span><span class="na">REF_STATUS_COL</span><span class="o">,</span> <span class="n">PROCESSED_COL</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">colVals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DocLoader</span><span class="o">.</span><span class="na">CONTENT_COL</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">colVals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DocLoader</span><span class="o">.</span><span class="na">REF_STATUS_COL</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">processed</span> <span class="o">=</span> <span class="n">colVals</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">PROCESSED_COL</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>

    <span class="c1">// TODO if status is referenced and not already processed the adjustCounts by +1 and set</span>
    <span class="c1">// PROCESSED_COL to true</span>

    <span class="c1">// TODO is status is unreferenced then delete all columns for content</span>
    <span class="c1">// TODO if status is unreferenced and document was processed, then adjust counts by -1</span>
  <span class="o">}</span>


  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">ObservedColumn</span> <span class="nf">getObservedColumn</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ObservedColumn</span><span class="o">(</span><span class="n">DocLoader</span><span class="o">.</span><span class="na">REF_STATUS_COL</span><span class="o">,</span> <span class="n">NotificationType</span><span class="o">.</span><span class="na">STRONG</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Something to think about: why observe the reference status column instead of the reference count
column?</p>

<p>When you are ready to run the observer, modify the <code class="highlighter-rouge">preInit()</code> method in <code class="highlighter-rouge">ft.Main</code> to configure the
observer as follows.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">preInit</span><span class="o">(</span><span class="n">FluoConfiguration</span> <span class="n">fluoConfig</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">fluoConfig</span><span class="o">.</span><span class="na">addObserver</span><span class="o">(</span><span class="k">new</span> <span class="n">ObserverSpecification</span><span class="o">(</span><span class="n">ContentObserver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>After implementing the Observer, the output of the program should look like the following.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>**** begin table dump ****
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc processed  true
  d:a6c4d1f doc refc  1
  d:a6c4d1f doc refs  referenced
  d:cf8ddc0 doc content  Bill plans to rescue Jebediah after taking tourist to Minimus.
  d:cf8ddc0 doc processed  true
  d:cf8ddc0 doc refc  1
  d:cf8ddc0 doc refs  referenced
  u:http://news.com/a23 uri hash  a6c4d1f
  u:http://news.com/a24 uri hash  cf8ddc0
  w:35 word docCount  1
  w:Bill word docCount  1
  w:Jebediah word docCount  2
  w:Minimus word docCount  1
  w:Mun word docCount  1
  w:No word docCount  1
  w:after word docCount  1
  w:days word docCount  1
  w:for word docCount  1
  w:forgot word docCount  1
  w:orbits word docCount  1
  w:panels word docCount  1
  w:plans word docCount  1
  w:power word docCount  1
  w:rescue word docCount  1
  w:solar word docCount  1
  w:taking word docCount  1
  w:to word docCount  1
  w:tourist word docCount  1
**** end table dump ****

**** begin table dump ****
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc processed  true
  d:a6c4d1f doc refc  2
  d:a6c4d1f doc refs  referenced
  d:cf8ddc0 doc content  Bill plans to rescue Jebediah after taking tourist to Minimus.
  d:cf8ddc0 doc processed  true
  d:cf8ddc0 doc refc  1
  d:cf8ddc0 doc refs  referenced
  u:http://news.com/a23 uri hash  a6c4d1f
  u:http://news.com/a24 uri hash  cf8ddc0
  u:http://oldnews.com/a23 uri hash  a6c4d1f
  w:35 word docCount  1
  w:Bill word docCount  1
  w:Jebediah word docCount  2
  w:Minimus word docCount  1
  w:Mun word docCount  1
  w:No word docCount  1
  w:after word docCount  1
  w:days word docCount  1
  w:for word docCount  1
  w:forgot word docCount  1
  w:orbits word docCount  1
  w:panels word docCount  1
  w:plans word docCount  1
  w:power word docCount  1
  w:rescue word docCount  1
  w:solar word docCount  1
  w:taking word docCount  1
  w:to word docCount  1
  w:tourist word docCount  1
**** end table dump ****

**** begin table dump ****
  d:2732ebc doc content  Crisis at KSC.  Tourist stuck at Minimus.  Bill forgot solar panels.
  d:2732ebc doc processed  true
  d:2732ebc doc refc  1
  d:2732ebc doc refs  referenced
  d:6658252 doc content  Jebediah orbits Mun for 38 days.  No power, forgot solar panels.
  d:6658252 doc processed  true
  d:6658252 doc refc  1
  d:6658252 doc refs  referenced
  d:a6c4d1f doc content  Jebediah orbits Mun for 35 days.  No power, forgot solar panels.
  d:a6c4d1f doc processed  true
  d:a6c4d1f doc refc  1
  d:a6c4d1f doc refs  referenced
  u:http://news.com/a23 uri hash  6658252
  u:http://news.com/a24 uri hash  2732ebc
  u:http://oldnews.com/a23 uri hash  a6c4d1f
  w:35 word docCount  1
  w:38 word docCount  1
  w:Bill word docCount  1
  w:Crisis word docCount  1
  w:Jebediah word docCount  2
  w:KSC word docCount  1
  w:Minimus word docCount  1
  w:Mun word docCount  2
  w:No word docCount  2
  w:Tourist word docCount  1
  w:at word docCount  1
  w:days word docCount  2
  w:for word docCount  2
  w:forgot word docCount  3
  w:orbits word docCount  2
  w:panels word docCount  3
  w:power word docCount  2
  w:solar word docCount  3
  w:stuck word docCount  1
**** end table dump ****
</code></pre>
</div>

<h2 id="part-3--using-fluo-recipes">Part 3 : Using Fluo Recipes</h2>

<p>The way to compute word counts above is very prone to transactional collisions. One way to avoid
these collisions is to use the CollisionFreeMap provided in Fluo Recipes. Currently Fluo Recipes is
not released, this section will be updated with more information once it is.</p>

</div>

<script>
document.body.onkeyup = function(e){

if (e.keyCode == '37') { window.location = '/tour/observer_example/'; }



if (e.keyCode == '39') { window.location = '/tour/row-locking/'; }

};
</script>

<div class="text-center">
 
  <h2> 
    
    <a href="/tour/observer_example/">&lt;</a> 
    

    19 / 26 
    
    <a href="/tour/row-locking/">&gt;</a> 
    
  </h2>
</div>

          </div>
      </div>
      <hr>
      <div class="row footer">
        <div class="col-sm-12 text-center">
          <div class="center-block">
          <a href="https://apache.org"><img src="/resources/feather.png" alt="Apache"></a>
          Copyright &copy; 2016 The Apache Software Foundation. Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache&nbsp;License,&nbsp;Version&nbsp;2.0</a>
          </div>
        </div>
      </div>
    </div>
    <script src="/javascripts/jquery.min.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <!-- Place your <script> tags here. -->

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55360307-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
